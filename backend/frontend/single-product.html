<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="https://fonts.googleapis.com/css?family=Poppins:100,200,300,400,500,600,700,800,900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <title>Hexashop - Product Details</title>

    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/templatemo-hexashop.css">
    <link rel="stylesheet" href="assets/css/owl-carousel.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css">
    <link rel="stylesheet" href="assets/css/single-product.css">

</head>

<body>
    <div id="preloader">
        <div class="jumper">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>  
    <header class="header-area header-sticky">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <nav class="main-nav">
                        <a href="index.html" class="logo">
                            <img src="med/logo3.png" alt="Hexashop Logo" class="img-fluid" style="height: 75px; width: auto;">
                        </a>
                        <ul class="nav">
                            <li class="scroll-to-section"><a href="index.html">Home</a></li>
                            <li class="scroll-to-section"><a href="index.html#men">Men</a></li>
                            <li class="scroll-to-section"><a href="index.html#women">Women</a></li>
                            <li class="scroll-to-section"><a href="index.html#kids">Kids</a></li>
                            <li class="submenu">
                                <a href="javascript:;">Pages</a>
                                <ul>
                                    <li><a href="index.html#brands" class="scroll-to-section">Our Brands</a></li> 
                                    <li><a href="tracking.html">Tracking/Order history</a></li>
                                    <li><a href="about.html">About Us</a></li>
                                    <li><a href="contact.html">Contact Us</a></li>
                                </ul>
                            </li>
                            <li class="scroll-to-section"><a href="cart.html"><i class="fa fa-shopping-cart"></i> Cart</a></li>
                        </ul>        
                        <a class='menu-trigger'>
                            <span>Menu</span>
                        </a>
                        </nav>
                </div>
            </div>
        </div>
    </header>
    <div class="page-heading" id="top">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="inner-content">
                        <h2>Product Details</h2>
                        <span>Discover the perfect eyewear for your style</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <section class="product-detail-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-6">
                    <div class="product-images-container">
                        <div class="thumbnail-column" id="thumbnailContainer">
                            </div>
                        <div class="main-image-container">
                            <img id="mainProductImage" class="main-image" src="" alt="Product Image">
                            <button class="image-nav nav-prev">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="image-nav nav-next">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="product-info">
                        <div class="brand-badge" id="productBrand"></div>
                        <h1 class="product-title" id="productTitle"></h1>
                        
                        <!-- UPDATED: Price display with discount support -->
                        <div class="price-container" id="productPriceContainer">
                            <div class="product-price" id="productPrice"></div>
                        </div>
                        
                        <div class="stock-info" id="stockInfo">
                            <i class="fas fa-box"></i> <span id="stockText">Loading stock...</span>
                        </div>
                        
                        <div class="product-description" id="productDescription">
                            <p>Loading product description...</p>
                        </div>
                        
                        <div class="product-details">
                            <div class="detail-item">
                                <div class="detail-label">Model:</div>
                                <div class="detail-value" id="productModel"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Frame Shape:</div>
                                <div class="detail-value" id="productFrameShape"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Frame Material:</div>
                                <div class="detail-value" id="productFrameMaterial"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Frame Color:</div>
                                <div class="detail-value" id="productFrameColor"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Lenses:</div>
                                <div class="detail-value" id="productLenses"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Protection:</div>
                                <div class="detail-value" id="productProtection"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Dimensions:</div>
                                <div class="detail-value" id="productDimensions"></div>
                            </div>
                        </div>
                        
                        <!-- NEW: Color and Quantity Selection -->
                        <div class="selection-container">
                            <!-- Color Selection (Left Side) -->
                            <div class="color-selection" id="colorSelectionSection" style="display: none;">
                                <div class="color-selection-label">Select Color:</div>
                                <div class="color-options" id="colorOptions">
                                    <!-- Color options will be dynamically generated here -->
                                </div>
                            </div>
                            
                            <!-- Quantity Selection (Right Side) -->
                            <div class="quantity-selection">
                                <label class="quantity-label">Quantity:</label>
                                <div class="quantity-controls">
                                    <button class="quantity-btn" id="decreaseQuantity" disabled>
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="1" readonly>
                                    <button class="quantity-btn" id="increaseQuantity">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <small class="text-muted" id="maxQuantityText">Max: 1 available</small>
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="order-button" id="orderNowBtn" disabled>Order Now</button>
                            <button class="add-to-cart-btn" id="addToCartBtn" disabled>Add to Cart</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section class="section" id="similar">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-heading">
                        <h2>You May Also Like</h2>
                        <span>Discover more eyewear that matches your style</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="similar-items-carousel">
                        <div class="owl-similar-items owl-carousel" id="similarCarousel">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div class="cart-message" id="cartMessage">
        <div class="cart-message-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="cart-message-content">
            <div class="cart-message-title">Item Added to Cart</div>
            <div class="cart-message-text" id="cartMessageText">Product has been added to your cart successfully!</div>
        </div>
        <button class="cart-message-close" id="cartMessageClose">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div id="orderNowModal" class="checkout-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Order with Cash on Delivery</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="product-summary">
                    <div class="product-image-small">
                        <img id="modalProductImage" src="" alt="Product Image">
                    </div>
                    <div class="product-info-summary">
                        <div class="product-title-row">
                            <div class="product-brand" id="modalProductBrand"></div>
                            <!-- UPDATED: Price display in modal -->
                            <div class="price-container" id="modalProductPriceContainer"></div>
                        </div>
                        <!-- NEW: Show selected color in modal -->
                        <div id="modalSelectedColor" class="selected-color-info" style="display: none;">
                            <strong>Color:</strong> <span id="modalColorName"></span>
                        </div>
                    </div>
                </div>

                <div class="order-summary-section">
                    <h5>Order Summary</h5>
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="modalSubtotal"></span>
                    </div>
                    <div class="summary-row">
                        <span>Discount</span>
                        <span id="modalDiscount">-DA 0</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery</span>
                        <span>Free</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>Total</span>
                        <span id="modalTotal"></span>
                    </div>
                </div>
    
                <div class="promo-section">
                    <h5>Promo Code</h5>
                    <div class="promo-code">
                        <input type="text" id="orderPromoCode" placeholder="Enter promo code">
                        <button id="applyPromoBtn">Apply</button>
                    </div>
                    <div id="promoMessage" class="promo-message"></div>
                </div>

                <div class="form-section">
                    <h5>Enter your delivery information</h5>
                    <div id="alert-message" class="alert-message"></div>
                    
                    <form id="order-now-form">
                        <div class="form-group">
                            <label for="orderFirstName" class="form-label">Full Name *</label>
                            <input type="text" class="form-control" id="orderFirstName" placeholder="Full Name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="orderPhoneNumber" class="form-label">Phone Number *</label>
                            <input type="tel" class="form-control" id="orderPhoneNumber" placeholder="Phone Number" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="orderWilaya" class="form-label">Wilaya *</label>
                            <div class="select-wrapper">
                                <select class="form-control" id="orderWilaya" required>
                                    <option value="" disabled selected>Select your wilaya</option>
                                    <option value="1">1 - Adrar</option>
                                    <option value="2">2 - Chlef</option>
                                    <option value="3">3 - Laghouat</option>
                                    <option value="4">4 - Oum El Bouaghi</option>
                                    <option value="5">5 - Batna</option>
                                    <option value="6">6 - B√©ja√Øa</option>
                                    <option value="7">7 - Biskra</option>
                                    <option value="8">8 - B√©char</option>
                                    <option value="9">9 - Blida</option>
                                    <option value="10">10 - Bouira</option>
                                    <option value="11">11 - Tamanrasset</option>
                                    <option value="12">12 - T√©bessa</option>
                                    <option value="13">13 - Tlemcen</option>
                                    <option value="14">14 - Tiaret</option>
                                    <option value="15">15 - Tizi Ouzou</option>
                                    <option value="16">16 - Alger</option>
                                    <option value="17">17 - Djelfa</option>
                                    <option value="18">18 - Jijel</option>
                                    <option value="19">19 - S√©tif</option>
                                    <option value="20">20 - Sa√Øda</option>
                                    <option value="21">21 - Skikda</option>
                                    <option value="22">22 - Sidi Bel Abb√®s</option>
                                    <option value="23">23 - Annaba</option>
                                    <option value="24">24 - Guelma</option>
                                    <option value="25">25 - Constantine</option>
                                    <option value="26">26 - M√©d√©a</option>
                                    <option value="27">27 - Mostaganem</option>
                                    <option value="28">28 - M'Sila</option>
                                    <option value="29">29 - Mascara</option>
                                    <option value="30">30 - Ouargla</option>
                                    <option value="31">31 - Oran</option>
                                    <option value="32">32 - El Bayadh</option>
                                    <option value="33">33 - Illizi</option>
                                    <option value="34">34 - Bordj Bou Arr√©ridj</option>
                                    <option value="35">35 - Boumerd√®s</option>
                                    <option value="36">36 - El Tarf</option>
                                    <option value="37">37 - Tindouf</option>
                                    <option value="38">38 - Tissemsilt</option>
                                    <option value="39">39 - El Oued</option>
                                    <option value="40">40 - Khenchela</option>
                                    <option value="41">41 - Souk Ahras</option>
                                    <option value="42">42 - Tipaza</option>
                                    <option value="43">43 - Mila</option>
                                    <option value="44">44 - A√Øn Defla</option>
                                    <option value="45">45 - Na√¢ma</option>
                                    <option value="46">46 - A√Øn T√©mouchent</option>
                                    <option value="47">47 - Gharda√Øa</option>
                                    <option value="48">48 - Relizane</option>
                                    <option value="49">49 - Timimoun</option>
                                    <option value="50">50 - Bordj Badji Mokhtar</option>
                                    <option value="51">51 - Ouled Djellal</option>
                                    <option value="52">52 - B√©ni Abb√®s</option>
                                    <option value="53">53 - In Salah</option>
                                    <option value="54">54 - In Guezzam</option>
                                    <option value="55">55 - Touggourt</option>
                                    <option value="56">56 - Djanet</option>
                                    <option value="57">57 - El M'Ghair</option>
                                    <option value="58">58 - El Menia</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="orderAddress" class="form-label">Address *</label>
                            <textarea class="form-control" id="orderAddress" rows="2" placeholder="Address" required></textarea>
                        </div>

                        <button type="submit" class="confirm-btn">
                            Confirm Order
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <footer style="background-color: #2a2a2a;" class="py-5">
    <div class="container">
        <div class="row">
            <div class="col-12 d-flex flex-column align-items-center">
                
                <nav class="footer-nav mb-4 d-flex flex-wrap justify-content-center gap-4">
                    <a href="index.html" class="text-white text-decoration-none px-2">Home</a>
                    <a href="about.html" class="text-white text-decoration-none px-2">About</a>
                    <a href="products.html" class="text-white text-decoration-none px-2">Products</a>
                    <a href="contact.html" class="text-white text-decoration-none px-2">Contact</a>
                </nav>

                <div class="mb-4 d-flex gap-3">
                    <a href="#" class="btn btn-outline-light rounded-circle footer-social-btn">
                        <i class="fa-brands fa-facebook-f"></i>
                        <span class="visually-hidden">Facebook</span>
                    </a>
                    <a href="https://www.instagram.com" class="btn btn-outline-light rounded-circle footer-social-btn">
                        <i class="fa-brands fa-instagram"></i>
                        <span class="visually-hidden">Instagram</span>
                    </a>
                    <a href="#" class="btn btn-outline-light rounded-circle footer-social-btn">
                        <i class="fa-brands fa-tiktok"></i>
                        <span class="visually-hidden">Tiktok</span>
                    </a>
                </div>

                <div class="text-center">
                    <p class="small text-white-50 mb-0">
                        Copyright ¬© 2023 Hexashop Co., Ltd. All Rights Reserved.
                    </p>
                </div>
            </div>
        </div>
    </div>
</footer>
    
    <!-- MOBILE BOTTOM NAVIGATION - ADDED FROM INDEX.HTML -->
    <div class="mobile-bottom-nav">
        <!-- Home -->
        <a href="index.html" class="nav-item">
            <svg class="icon icon-home icon-sm" width="20" height="20" viewBox="0 0 20 20" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" d="M18.3337 14.1667V10.4538C18.3337 9.09868 18.3337 8.42113 18.1681 7.79394C18.006 7.17971 17.7284 6.602 17.35 6.09172C16.9637 5.57066 16.4346 5.1474 15.3764 4.30088L14.9979 3.99805L14.9979 3.99804C13.2143 2.57117 12.3225 1.85774 11.3335 1.58413C10.4611 1.34279 9.53956 1.34279 8.66717 1.58413C7.67815 1.85774 6.78636 2.57118 5.00277 3.99805L5.00276 3.99805L4.62423 4.30088C3.56607 5.1474 3.037 5.57066 2.65064 6.09172C2.27227 6.602 1.99461 7.17971 1.83251 7.79394C1.66699 8.42113 1.66699 9.09868 1.66699 10.4538V14.1667C1.66699 16.4679 3.53247 18.3333 5.83366 18.3333C6.75413 18.3333 7.50033 17.5871 7.50033 16.6667V13.3333C7.50033 11.9526 8.61961 10.8333 10.0003 10.8333C11.381 10.8333 12.5003 11.9526 12.5003 13.3333V16.6667C12.5003 17.5871 13.2465 18.3333 14.167 18.3333C16.4682 18.3333 18.3337 16.4679 18.3337 14.1667Z"/>
            </svg>
            <span>Home</span>
        </a>
        
        <!-- Menu -->
        <a href="javascript:void(0);" class="nav-item menu-trigger-bottom">
            <svg class="icon icon-hamburger icon-sm" width="20" height="20" viewBox="0 0 21 20" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.2002 5H18.2002M3.2002 10H9.86686M3.2002 15H14.0335"/>
            </svg>
            <span>Menu</span>
        </a>
        
        <!-- Shop -->
        <a href="products.html" class="nav-item">
            <svg class="icon icon-grid icon-sm" width="20" height="20" viewBox="0 0 21 20" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" d="M1.7666 4.8665C1.7666 3.7464 1.7666 3.18635 1.98459 2.75852C2.17634 2.3822 2.4823 2.07624 2.85862 1.88449C3.28644 1.6665 3.8465 1.6665 4.9666 1.6665H5.23327C6.35337 1.6665 6.91343 1.6665 7.34125 1.88449C7.71757 2.07624 8.02353 2.3822 8.21528 2.75852C8.43327 3.18635 8.43327 3.7464 8.43327 4.8665V5.13317C8.43327 6.25328 8.43327 6.81333 8.21528 7.24115C8.02353 7.61748 7.71757 7.92344 7.34125 8.11518C6.91343 8.33317 6.35337 8.33317 5.23327 8.33317H4.9666C3.8465 8.33317 3.28644 8.33317 2.85862 8.11518C2.4823 7.92344 2.17634 7.61748 1.98459 7.24115C1.7666 6.81333 1.7666 6.25328 1.7666 5.13317V4.8665Z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.7666 4.8665C11.7666 3.7464 11.7666 3.18635 11.9846 2.75852C12.1763 2.3822 12.4823 2.07624 12.8586 1.88449C13.2864 1.6665 13.8465 1.6665 14.9666 1.6665H15.2333C16.3534 1.6665 16.9134 1.6665 17.3413 1.88449C17.7176 2.07624 18.0235 2.3822 18.2153 2.75852C18.4333 3.18635 18.4333 3.7464 18.4333 4.8665V5.13317C18.4333 6.25328 18.4333 6.81333 18.2153 7.24115C18.0235 7.61748 17.7176 7.92344 17.3413 8.11518C16.9134 8.33317 16.3534 8.33317 15.2333 8.33317H14.9666C13.8465 8.33317 13.2864 8.33317 12.8586 8.11518C12.4823 7.92344 12.1763 7.61748 11.9846 7.24115C11.7666 6.81333 11.7666 6.25328 11.7666 5.13317V4.8665Z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M1.7666 14.8665C1.7666 13.7464 1.7666 13.1863 1.98459 12.7585C2.17634 12.3822 2.4823 12.0762 2.85862 11.8845C3.28644 11.6665 3.8465 11.6665 4.9666 11.6665H5.23327C6.35337 11.6665 6.91343 11.6665 7.34125 11.8845C7.71757 12.0762 8.02353 12.3822 8.21528 12.7585C8.43327 13.1863 8.43327 13.7464 8.43327 14.8665V15.1332C8.43327 16.2533 8.43327 16.8133 8.21528 17.2412C8.02353 17.6175 7.71757 17.9234 7.34125 18.1152C6.91343 18.3332 6.35337 18.3332 5.23327 18.3332H4.9666C3.8465 18.3332 3.28644 18.3332 2.85862 18.1152C2.4823 17.9234 2.17634 17.6175 1.98459 17.2412C1.7666 16.8133 1.7666 16.2533 1.7666 15.1332V14.8665Z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.7666 14.8665C11.7666 13.7464 11.7666 13.1863 11.9846 12.7585C12.1763 12.3822 12.4823 12.0762 12.8586 11.8845C13.2864 11.6665 13.8465 11.6665 14.9666 11.6665H15.2333C16.3534 11.6665 16.9134 11.6665 17.3413 11.8845C17.7176 12.0762 18.0235 12.3822 18.2153 12.7585C18.4333 13.1863 18.4333 13.7464 18.4333 14.8665V15.1332C18.4333 16.2533 18.4333 16.8133 18.2153 17.2412C18.0235 17.6175 17.7176 17.9234 17.3413 18.1152C16.9134 18.3332 16.3534 18.3332 15.2333 18.3332H14.9666C13.8465 18.3332 13.2864 18.3332 12.8586 18.1152C12.4823 17.9234 12.1763 17.6175 11.9846 17.2412C11.7666 16.8133 11.7666 16.2533 11.7666 15.1332V14.8665Z"/>
            </svg>
            <span>Shop</span>
        </a>
        
        <!-- Cart -->
        <a href="cart.html" class="nav-item">
            <svg class="icon icon-cart icon-sm" width="20" height="20" viewBox="0 0 20 20" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" d="M1.66667 1.66667H3.33333L5.83333 11.6667H16.6667L18.3333 4.16667H5.83333M5.83333 15.8333C5.83333 16.7538 6.57953 17.5 7.5 17.5C8.42047 17.5 9.16667 16.7538 9.16667 15.8333C9.16667 14.9129 8.42047 14.1667 7.5 14.1667C6.57953 14.1667 5.83333 14.9129 5.83333 15.8333ZM14.1667 15.8333C14.1667 16.7538 14.9129 17.5 15.8333 17.5C16.7538 17.5 17.5 16.7538 17.5 15.8333C17.5 14.9129 16.7538 14.1667 15.8333 14.1667C14.9129 14.1667 14.1667 14.9129 14.1667 15.8333Z"/>
            </svg>
            <span>Cart</span>
        </a>
        
        <!-- Tracking -->
        <a href="tracking.html" class="nav-item">
            <svg class="icon icon-tracking icon-sm" width="20" height="20" viewBox="0 0 20 20" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 18.3333C10 18.3333 17.5 12.5 17.5 8.33333C17.5 4.16667 14.1667 0.833333 10 0.833333C5.83333 0.833333 2.5 4.16667 2.5 8.33333C2.5 12.5 10 18.3333 10 18.3333Z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 10.8333C11.3807 10.8333 12.5 9.71405 12.5 8.33333C12.5 6.95262 11.3807 5.83333 10 5.83333C8.61929 5.83333 7.5 6.95262 7.5 8.33333C7.5 9.71405 8.61929 10.8333 10 10.8333Z"/>
            </svg>
            <span>Tracking</span>
        </a>
    </div>
    <!-- END MOBILE BOTTOM NAVIGATION -->

    <script src="assets/js/jquery-2.1.0.min.js"></script>

    <script src="assets/js/popper.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>

    <script src="assets/js/owl-carousel.js"></script>
    <script src="assets/js/accordions.js"></script>
    <script src="assets/js/datepicker.js"></script>
    <script src="assets/js/scrollreveal.min.js"></script>
    <script src="assets/js/waypoints.min.js"></script>
    <script src="assets/js/jquery.counterup.min.js"></script>
    <script src="assets/js/imgfix.min.js"></script> 
    <script src="assets/js/slick.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
    <script src="assets/js/isotope.js"></script> 
    
    <script src="assets/js/custom.js"></script>

 <script>
    // API Base URL - points to your backend
    const API_BASE = '/api';

    // NEW: Color selection variables
    let selectedColor = '';
    let availableColors = [];

    // INFINITE CAROUSEL VARIABLES
    let currentImageIndex = 0;
    let currentProduct = null;
    let thumbnailTrack = null;
    let isDragging = false;
    let startPosition = 0;
    let currentTranslate = 0;
    let previousTranslate = 0;
    let animationID = null;
    let images = [];
    let isMobile = false;

    // Cart management functions
    function getCart() {
        const cartData = localStorage.getItem('hexashop-cart');
        return cartData ? JSON.parse(cartData) : [];
    }
    
    function saveCart(cart) {
        localStorage.setItem('hexashop-cart', JSON.stringify(cart));
    }
    
    function updateCartCount() {
        const cart = getCart();
        const cartCount = cart.reduce((total, item) => total + item.quantity, 0);
        
        const cartIcon = document.querySelector('.fa-shopping-cart');
        if (cartIcon) {
            const existingBadge = cartIcon.parentElement.querySelector('.cart-badge');
            if (existingBadge) {
                existingBadge.remove();
            }
            
            if (cartCount > 0) {
                const badge = document.createElement('span');
                badge.className = 'cart-badge';
                badge.textContent = cartCount;
                badge.style.cssText = `
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    background: #ced4da;
                    color: white;
                    border-radius: 50%;
                    width: 18px;
                    height: 18px;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                cartIcon.parentElement.style.position = 'relative';
                cartIcon.parentElement.appendChild(badge);
            }
        }
    }
    
    function showCartMessage(message, type = 'success') {
        const cartMessage = document.getElementById('cartMessage');
        const cartMessageText = document.getElementById('cartMessageText');
        const cartMessageIcon = cartMessage.querySelector('.cart-message-icon');
        
        cartMessageText.textContent = message;
        
        if (type === 'error') {
            cartMessage.style.backgroundColor = '#dc3545';
            cartMessageIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
        } else {
            cartMessage.style.backgroundColor = '#6c757d';
            cartMessageIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
        }
        
        cartMessage.classList.remove('hide');
        cartMessage.classList.add('show');
        
        setTimeout(() => {
            hideCartMessage();
        }, 4000);
    }
    
    function hideCartMessage() {
        const cartMessage = document.getElementById('cartMessage');
        cartMessage.classList.remove('show');
        cartMessage.classList.add('hide');
    }

    // Add to cart function with color selection
    function addToCart(product, quantity, selectedColor = '') {
        const cart = getCart();
        
        const existingItemIndex = cart.findIndex(item => 
            item.id === product.id && item.selectedColor === selectedColor
        );
        
        // Store both original and current price for discount display
        const hasActiveDiscount = product.has_active_discount && product.discount_price;
        const currentPrice = hasActiveDiscount ? product.discount_price : product.price;
        const originalPrice = product.price; // Always store the original price
        
        if (existingItemIndex > -1) {
            // Check if adding more would exceed available stock
            const newTotalQuantity = cart[existingItemIndex].quantity + quantity;
            if (newTotalQuantity > currentProductQuantity) {
                showCartMessage(`Cannot add more. Only ${currentProductQuantity - cart[existingItemIndex].quantity} available.`, 'error');
                return;
            }
            cart[existingItemIndex].quantity += quantity;
            // Update prices in case they changed
            cart[existingItemIndex].price = currentPrice;
            cart[existingItemIndex].originalPrice = originalPrice;
            cart[existingItemIndex].hasDiscount = hasActiveDiscount;
        } else {
            // Get the first image for the selected color, or fallback to first available image
            let productImage = '';
            if (selectedColor && availableColors.length > 0) {
                const colorData = availableColors.find(color => color.name === selectedColor);
                if (colorData && colorData.images && colorData.images.length > 0) {
                    productImage = colorData.images[0];
                }
            }
            
            // Fallback to existing images if no color-specific image found
            if (!productImage) {
                const images = typeof product.images === 'string' ? JSON.parse(product.images) : product.images;
                const firstImageArray = Object.values(images)[0] || [];
                productImage = firstImageArray[0] || '';
            }
            
            const cartItem = {
                id: product.id,
                name: product.title,
                price: currentPrice, // Current price (discounted or regular)
                originalPrice: originalPrice, // Always the original price for comparison
                image: productImage,
                category: product.model,
                type: product.frame_shape,
                quantity: quantity,
                brand: product.brand,
                maxQuantity: currentProductQuantity,
                hasDiscount: hasActiveDiscount,
                // Store selected color - for single color products, use the automatically selected color
                selectedColor: selectedColor || (availableColors.length === 1 ? availableColors[0].name : '')
            };
            cart.push(cartItem);
        }
        
        saveCart(cart);
        updateCartCount();
        
        // Show appropriate message based on discount and color
        let message = `${product.title} (${quantity}) added to cart!`;
        if (selectedColor) {
            message += ` Color: ${selectedColor}`;
        }
        if (hasActiveDiscount) {
            message += ' Amazing deal! üè∑Ô∏è';
        }
        
        showCartMessage(message);
    }

    // Fetch product from backend API
    async function fetchProduct(productId) {
        try {
            const response = await fetch(`${API_BASE}/products/${productId}`);
            if (!response.ok) {
                throw new Error('Product not found');
            }
            return await response.json();
        } catch (error) {
            console.error('Error fetching product:', error);
            return null;
        }
    }

    // Fetch similar products from backend - same category
    async function fetchSimilarProducts(category, currentProductId) {
        try {
            const response = await fetch(`${API_BASE}/products/category/${category}`);
            if (!response.ok) {
                throw new Error('Failed to fetch similar products');
            }
            const products = await response.json();
            // Filter out current product and return up to 6 products
            return products.filter(product => product.id !== currentProductId).slice(0, 6);
        } catch (error) {
            console.error('Error fetching similar products:', error);
            return [];
        }
    }

    // Display similar products - Updated with discount support
    function displaySimilarProducts(similarProducts) {
        const carousel = document.getElementById('similarCarousel');
        if (!carousel) return;
        
        carousel.innerHTML = '';
        
        if (similarProducts.length === 0) {
            carousel.innerHTML = '<div class="col-12 text-center"><p>No similar products found.</p></div>';
            return;
        }
        
        similarProducts.forEach(product => {
            // Get the first image from the first color for display
            let firstImage = 'assets/images/default-product.jpg';
            if (product.available_colors && product.available_colors.length > 0) {
                const firstColor = product.available_colors[0];
                if (firstColor.images && firstColor.images.length > 0) {
                    firstImage = firstColor.images[0];
                }
            }

            // Price display with discount support
            let priceHTML = '';
            if (product.has_active_discount && product.discount_price) {
                const discountPercent = Math.round((1 - product.discount_price / product.price) * 100);
                priceHTML = `
                    <div class="price-container">
                        <span class="original-price">DA ${product.price.toLocaleString()}</span>
                        <span class="discount-price">DA ${product.discount_price.toLocaleString()}</span>
                        <span class="discount-badge">-${discountPercent}%</span>
                    </div>
                `;
            } else {
                priceHTML = `<span class="similar-item-price">DA ${product.price.toLocaleString()}</span>`;
            }

            const productHtml = `
                <div class="similar-item">
                    <div class="thumb">
                        <div class="hover-content">
                            <ul>
                                <li><a href="single-product.html?product=${product.id}"><i class="fa fa-eye"></i></a></li>
                            </ul>
                        </div>
                        <img src="${firstImage}" alt="${product.title}">
                    </div>
                    <div class="similar-item-info">
                        <h4 class="similar-item-title">${product.title}</h4>
                        ${priceHTML}
                    </div>
                </div>
            `;
            
            carousel.innerHTML += productHtml;
        });

        // Initialize carousel after products are loaded
        initializeSimilarCarousel();
    }

    function initializeSimilarCarousel() {
        const $carousel = $('.owl-similar-items');
        
        // Destroy any existing carousel instance
        if ($carousel.data('owl.carousel')) {
            $carousel.trigger('destroy.owl.carousel');
            $carousel.removeClass('owl-loaded owl-hidden');
        }
        
        // Initialize with 3 items per row and centered layout
        $carousel.owlCarousel({
            loop: true,
            margin: 25,
            nav: true,
            navText: [
                '<i class="fa fa-angle-left"></i>',
                '<i class="fa fa-angle-right"></i>'
            ],
            dots: false,
            autoplay: false,
            center: false,
            responsive: {
                0: {
                    items: 1
                },
                576: {
                    items: 2
                },
                768: {
                    items: 3
                },
                992: {
                    items: 3
                },
                1200: {
                    items: 3
                }
            }
        });
    }

    // Color selection functions
    function displayColorOptions(colors) {
        const colorSection = document.getElementById('colorSelectionSection');
        const colorOptions = document.getElementById('colorOptions');
        
        if (colors && colors.length > 1) {
            // Show color selection section for multiple colors
            colorSection.style.display = 'block';
            colorOptions.innerHTML = '';
            
            // Create color options
            colors.forEach((color, index) => {
                const colorOption = document.createElement('div');
                colorOption.className = 'color-option';
                colorOption.dataset.colorName = color.name;
                
                const firstImage = color.images && color.images.length > 0 ? color.images[0] : 'assets/images/default-product.jpg';
                
                colorOption.innerHTML = `
                    <img src="${firstImage}" alt="${color.name}" class="color-thumbnail">
                    <div class="color-name">${color.name}</div>
                    <div class="color-check"><i class="fas fa-check"></i></div>
                `;
                
                colorOption.addEventListener('click', () => selectColor(color.name, colorOption));
                
                // Select first color by default
                if (index === 0) {
                    selectColor(color.name, colorOption);
                }
                
                colorOptions.appendChild(colorOption);
            });
        } else if (colors && colors.length === 1) {
            // For single color products, hide selection but set the color automatically
            colorSection.style.display = 'none';
            const singleColor = colors[0];
            selectedColor = singleColor.name;
            
            // Update stock display for the single color
            updateStockDisplayForColor(singleColor);
            
            // Enable buttons since we have a color selected
            updateButtonStates();
        } else {
            // Hide color selection section and disable buttons if no colors
            colorSection.style.display = 'none';
            selectedColor = '';
            updateButtonStates();
        }
    }

    function selectColor(colorName, colorElement) {
        // Remove selected class from all color options
        document.querySelectorAll('.color-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Add selected class to clicked color option
        colorElement.classList.add('selected');
        selectedColor = colorName;
        
        // Update main product image with the first image of selected color
        const selectedColorData = availableColors.find(color => color.name === colorName);
        if (selectedColorData && selectedColorData.images && selectedColorData.images.length > 0) {
            // Reset to first image of new color
            currentImageIndex = 0;
            images = selectedColorData.images;
            
            document.getElementById('mainProductImage').src = selectedColorData.images[0];
            
            // Update thumbnails for the selected color
            updateThumbnailsForColor(selectedColorData.images);
        }
        
        // Update stock display for selected color
        updateStockDisplayForColor(selectedColorData);
        
        // Enable buttons if color is selected
        updateButtonStates();
    }

    // Function to update stock display for specific color
    function updateStockDisplayForColor(colorData) {
        const stockInfo = document.getElementById('stockInfo');
        const stockText = document.getElementById('stockText');
        const quantityInput = document.getElementById('quantityInput');
        const maxQuantityText = document.getElementById('maxQuantityText');

        // Handle case where colorData might be undefined
        if (!colorData && availableColors.length === 1) {
            colorData = availableColors[0];
        }
        
        if (!colorData) {
            // Fallback - shouldn't happen with required colors
            currentProductQuantity = 0;
            stockInfo.className = 'stock-info stock-out';
            stockText.innerHTML = `<i class="fas fa-times-circle"></i> Product unavailable`;
            quantityInput.disabled = true;
            updateQuantityControls();
            return;
        }

        const colorStock = colorData.stock || 0;
        currentProductQuantity = colorStock;
        
        // Update quantity input max value
        quantityInput.max = colorStock;
        
        // Update max quantity text - handle single vs multiple colors
        if (availableColors.length > 1) {
            maxQuantityText.textContent = `Max: ${colorStock} available for ${colorData.name}`;
        } else {
            maxQuantityText.textContent = `Max: ${colorStock} available`;
        }

        if (colorStock === 0) {
            // Out of stock
            stockInfo.className = 'stock-info stock-out';
            if (availableColors.length > 1) {
                stockText.innerHTML = `<i class="fas fa-times-circle"></i> Out of Stock for ${colorData.name}`;
            } else {
                stockText.innerHTML = `<i class="fas fa-times-circle"></i> Out of Stock`;
            }
            quantityInput.disabled = true;
            updateQuantityControls();
        } else if (colorStock <= 5) {
            // Low stock
            stockInfo.className = 'stock-info stock-low';
            if (availableColors.length > 1) {
                stockText.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Only ${colorStock} left in stock for ${colorData.name}!`;
            } else {
                stockText.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Only ${colorStock} left in stock!`;
            }
            quantityInput.disabled = false;
            updateQuantityControls();
        } else {
            // In stock
            stockInfo.className = 'stock-info stock-available';
            if (availableColors.length > 1) {
                stockText.innerHTML = `<i class="fas fa-check-circle"></i> In Stock for ${colorData.name} (${colorStock} available)`;
            } else {
                stockText.innerHTML = `<i class="fas fa-check-circle"></i> In Stock (${colorStock} available)`;
            }
            quantityInput.disabled = false;
            updateQuantityControls();
        }
    }

    // INFINITE CAROUSEL FUNCTIONS

    // Initialize thumbnail carousel
    function initThumbnailCarousel() {
        const thumbnailContainer = document.getElementById('thumbnailContainer');
        if (!thumbnailContainer) return;
        
        // Create track element
        thumbnailTrack = document.createElement('div');
        thumbnailTrack.className = 'thumbnail-track';
        thumbnailContainer.innerHTML = '';
        thumbnailContainer.appendChild(thumbnailTrack);
        
        // Check if mobile
        isMobile = window.innerWidth <= 768;
        
        // Setup event listeners based on device
        if (isMobile) {
            setupMobileTouchEvents();
        } else {
            setupDesktopWheelEvents();
        }
    }

    // Setup touch events for mobile
    function setupMobileTouchEvents() {
        if (!thumbnailTrack) return;
        
        thumbnailTrack.addEventListener('touchstart', touchStart, { passive: false });
        thumbnailTrack.addEventListener('touchmove', touchMove, { passive: false });
        thumbnailTrack.addEventListener('touchend', touchEnd);
        
        // Mouse events for desktop testing
        thumbnailTrack.addEventListener('mousedown', touchStart);
        thumbnailTrack.addEventListener('mousemove', touchMove);
        thumbnailTrack.addEventListener('mouseup', touchEnd);
        thumbnailTrack.addEventListener('mouseleave', touchEnd);
    }

    // Setup wheel events for desktop
    function setupDesktopWheelEvents() {
        if (!thumbnailTrack) return;
        
        thumbnailTrack.addEventListener('wheel', handleWheel, { passive: false });
    }

    // Touch/Mouse handlers
    function touchStart(event) {
        isDragging = true;
        thumbnailTrack.classList.add('grabbing');
        thumbnailTrack.style.transition = 'none';
        
        if (isMobile) {
            startPosition = getPositionX(event);
        } else {
            startPosition = event.clientY;
        }
        
        cancelAnimationFrame(animationID);
    }

    function touchMove(event) {
        if (!isDragging) return;
        
        event.preventDefault();
        
        if (isMobile) {
            const currentPosition = getPositionX(event);
            currentTranslate = previousTranslate + currentPosition - startPosition;
            setThumbnailPosition();
        }
    }

    function touchEnd() {
        if (!isDragging) return;
        
        isDragging = false;
        thumbnailTrack.classList.remove('grabbing');
        thumbnailTrack.style.transition = 'transform 0.3s ease';
        
        const movedDistance = Math.abs(currentTranslate - previousTranslate);
        
        // Snap to nearest thumbnail if moved enough
        if (movedDistance > 30) {
            if (isMobile) {
                const direction = currentTranslate < previousTranslate ? 'next' : 'prev';
                navigateImage(direction);
            }
        }
        
        // Return to original position
        setThumbnailPosition(previousTranslate);
        currentTranslate = previousTranslate;
    }

    function handleWheel(event) {
        event.preventDefault();
        
        // Get all thumbnails
        const thumbnails = document.querySelectorAll('.thumbnail');
        if (thumbnails.length === 0) return;
        
        const delta = Math.sign(event.deltaY);
        let newIndex = currentImageIndex + delta;
        
        // Infinite loop
        if (newIndex < 0) newIndex = images.length - 1;
        if (newIndex >= images.length) newIndex = 0;
        
        // Update display
        selectThumbnail(newIndex);
    }

    function getPositionX(event) {
        return event.type.includes('mouse') ? event.clientX : event.touches[0].clientX;
    }

    function setThumbnailPosition(x = currentTranslate) {
        if (!thumbnailTrack) return;
        
        if (isMobile) {
            thumbnailTrack.style.transform = `translateX(${x}px)`;
        } else {
            thumbnailTrack.style.transform = `translateY(${x}px)`;
        }
    }

    // Update thumbnails for selected color
    function updateThumbnailsForColor(colorImages) {
        if (!colorImages || colorImages.length === 0) return;
        
        images = colorImages;
        
        // Initialize carousel if not already done
        if (!thumbnailTrack) {
            initThumbnailCarousel();
        }
        
        // Clear existing thumbnails
        thumbnailTrack.innerHTML = '';
        
        // Create thumbnails
        images.forEach((image, index) => {
            const thumbnail = document.createElement('div');
            thumbnail.className = `thumbnail ${index === currentImageIndex ? 'active' : ''}`;
            thumbnail.dataset.index = index;
            
            thumbnail.innerHTML = `
                <img src="${image}" 
                     alt="Product View ${index + 1}" 
                     loading="lazy"
                     onerror="this.src='assets/images/default-product.jpg'">
            `;
            
            thumbnail.addEventListener('click', () => {
                if (isDragging) return;
                selectThumbnail(index);
            });
            
            thumbnailTrack.appendChild(thumbnail);
        });
        
        // Center the active thumbnail
        centerThumbnail(currentImageIndex);
    }

    // Select thumbnail and update main image
    function selectThumbnail(index) {
        if (!images || index < 0 || index >= images.length) return;
        
        // Update current index
        currentImageIndex = index;
        
        // Update main image
        const mainImage = document.getElementById('mainProductImage');
        mainImage.style.opacity = '0';
        
        setTimeout(() => {
            mainImage.src = images[index];
            mainImage.style.opacity = '1';
        }, 150);
        
        // Update active thumbnail
        document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
            thumb.classList.toggle('active', i === index);
        });
        
        // Center the selected thumbnail
        centerThumbnail(index);
    }

    // Center the selected thumbnail in view
    function centerThumbnail(index) {
        if (!thumbnailTrack || images.length === 0) return;
        
        const thumbnails = document.querySelectorAll('.thumbnail');
        if (!thumbnails[index]) return;
        
        if (isMobile) {
            // Horizontal centering for mobile
            const thumbnailWidth = 70; // Matches CSS
            const gap = 10;
            const containerWidth = thumbnailTrack.parentElement.offsetWidth;
            const trackWidth = (thumbnailWidth + gap) * images.length - gap;
            
            let targetPosition = -index * (thumbnailWidth + gap) + (containerWidth - thumbnailWidth) / 2;
            
            // Clamp to boundaries
            const maxScroll = Math.max(0, trackWidth - containerWidth);
            targetPosition = Math.min(0, Math.max(-maxScroll, targetPosition));
            
            previousTranslate = targetPosition;
            currentTranslate = targetPosition;
            thumbnailTrack.style.transform = `translateX(${targetPosition}px)`;
        } else {
            // Vertical centering for desktop
            const thumbnailHeight = 100; // Matches CSS
            const gap = 10;
            const containerHeight = thumbnailTrack.parentElement.offsetHeight;
            const trackHeight = (thumbnailHeight + gap) * images.length - gap;
            
            let targetPosition = -index * (thumbnailHeight + gap) + (containerHeight - thumbnailHeight) / 2;
            
            // Clamp to boundaries
            const maxScroll = Math.max(0, trackHeight - containerHeight);
            targetPosition = Math.min(0, Math.max(-maxScroll, targetPosition));
            
            previousTranslate = targetPosition;
            currentTranslate = targetPosition;
            thumbnailTrack.style.transform = `translateY(${targetPosition}px)`;
        }
    }

    // Image navigation with infinite loop
    function navigateImage(direction) {
        if (images.length === 0) return;
        
        let newIndex;
        if (direction === 'next') {
            newIndex = (currentImageIndex + 1) % images.length;
        } else {
            newIndex = (currentImageIndex - 1 + images.length) % images.length;
        }
        
        selectThumbnail(newIndex);
    }

    // Handle window resize
    function handleResize() {
        const wasMobile = isMobile;
        isMobile = window.innerWidth <= 768;
        
        // Reinitialize if orientation changed
        if (wasMobile !== isMobile && images.length > 0) {
            updateThumbnailsForColor(images);
            centerThumbnail(currentImageIndex);
        }
    }

    // Stock and quantity management - using color-specific quantities only
    let currentProductQuantity = 0;
    let currentQuantity = 1;

    function updateButtonStates() {
        const orderBtn = document.getElementById('orderNowBtn');
        const cartBtn = document.getElementById('addToCartBtn');
        
        // Enable buttons only if product is in stock and:
        // - For multiple colors: a color must be selected
        // - For single color: automatically considered as selected
        // - For no colors: disabled (shouldn't happen with new required color system)
        const hasColors = availableColors.length > 0;
        const isColorSelected = availableColors.length > 1 ? selectedColor !== '' : true;
        const isInStock = currentProductQuantity > 0;
        
        orderBtn.disabled = !(hasColors && isColorSelected && isInStock);
        cartBtn.disabled = !(hasColors && isColorSelected && isInStock);
    }

    function updateQuantityControls() {
        const quantityInput = document.getElementById('quantityInput');
        const decreaseBtn = document.getElementById('decreaseQuantity');
        const increaseBtn = document.getElementById('increaseQuantity');

        decreaseBtn.disabled = currentQuantity <= 1;
        increaseBtn.disabled = currentQuantity >= currentProductQuantity;
        
        // Update quantity input value
        quantityInput.value = currentQuantity;
    }

    // Product display functions

    function updateProductDisplay(product) {
        // Remove loading states
        document.getElementById('productTitle').classList.remove('loading');
        document.getElementById('productPrice').classList.remove('loading');
        document.getElementById('productDescription').classList.remove('loading');
        
        // Update product details
        document.getElementById('productTitle').textContent = product.title;
        document.getElementById('productBrand').textContent = product.brand;
        document.getElementById('productDescription').innerHTML = `<p>${product.description}</p>`;
        
        document.getElementById('productModel').textContent = product.model;
        document.getElementById('productFrameShape').textContent = product.frame_shape;
        document.getElementById('productFrameMaterial').textContent = product.frame_material;
        document.getElementById('productFrameColor').textContent = product.frame_color;
        document.getElementById('productLenses').textContent = product.lenses;
        document.getElementById('productProtection').textContent = product.protection;
        document.getElementById('productDimensions').textContent = product.dimensions;
        
        // Price display with discount support
        updatePriceDisplay(product);
        
        // Update color selection
        availableColors = product.available_colors || [];
        displayColorOptions(availableColors);
        
        // Update stock display - if single color, it's already handled in displayColorOptions
        if (availableColors.length === 0) {
            // Fallback if no colors available (shouldn't happen with required colors)
            currentProductQuantity = 0;
            updateButtonStates();
        }
        
        // Load similar products from same category
        fetchSimilarProducts(product.model.toLowerCase(), product.id).then(similarProducts => {
            displaySimilarProducts(similarProducts);
        });
    }

    // Function to update price display with discount support
    function updatePriceDisplay(product) {
        const priceContainer = document.getElementById('productPriceContainer');
        
        if (product.has_active_discount && product.discount_price) {
            const discountPercent = Math.round((1 - product.discount_price / product.price) * 100);
            const savingAmount = product.price - product.discount_price;
            
            priceContainer.innerHTML = `
                <div class="price-container">
                    <span class="original-price">DA ${product.price.toLocaleString()}</span>
                    <span class="discount-price">DA ${product.discount_price.toLocaleString()}</span>
                    <span class="discount-badge">-${discountPercent}%</span>
                </div>
                <div class="saving-text">
                    You can save up to ${savingAmount.toLocaleString()} DZD!
                </div>
            `;
        } else {
            priceContainer.innerHTML = `
                <div class="product-price">DA ${product.price.toLocaleString()}</div>
            `;
        }
    }

    function updateImages(product) {
        const mainImage = document.getElementById('mainProductImage');
        
        // Use first image from first available color
        let firstImage = 'assets/images/default-product.jpg';
        if (availableColors.length > 0) {
            const firstColor = availableColors[0];
            if (firstColor.images && firstColor.images.length > 0) {
                firstImage = firstColor.images[0];
                images = firstColor.images;
                currentImageIndex = 0;
            }
        }
        
        // Update main image
        mainImage.src = firstImage;
        mainImage.alt = product.title;
        
        // Update thumbnails for first color
        if (availableColors.length > 0) {
            const firstColor = availableColors[0];
            updateThumbnailsForColor(firstColor.images);
        }
    }

    // Order Now Modal functionality
    let appliedPromoCode = null;
    let currentProductPrice = 0;

    function openOrderNowModal() {
        const modal = document.getElementById('orderNowModal');
        if (!modal) return;
        
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        appliedPromoCode = null;
        const promoInput = document.getElementById('orderPromoCode');
        if (promoInput) {
            promoInput.value = '';
            promoInput.disabled = false;
        }
        const applyBtn = document.getElementById('applyPromoBtn');
        if (applyBtn) applyBtn.textContent = 'Apply';
        const promoMessage = document.getElementById('promoMessage');
        if (promoMessage) promoMessage.style.display = 'none';
        
        // Populate product details
        const productTitle = document.getElementById('productTitle').textContent;
        const productBrand = document.getElementById('productBrand').textContent;
        const productImage = document.getElementById('mainProductImage').src;
        
        // Use discounted price if available
        const hasActiveDiscount = currentProduct.has_active_discount;
        currentProductPrice = hasActiveDiscount && currentProduct.discount_price ? currentProduct.discount_price : currentProduct.price;
        
        document.getElementById('modalProductImage').src = productImage;
        document.getElementById('modalProductBrand').textContent = `${productBrand} - ${productTitle}`;
        
        // Show selected color in modal if available
        const selectedColorInfo = document.getElementById('modalSelectedColor');
        const modalColorName = document.getElementById('modalColorName');
        if (selectedColor && availableColors.length > 1) {
            selectedColorInfo.style.display = 'block';
            modalColorName.textContent = selectedColor;
        } else if (availableColors.length === 1) {
            // Show color for single color products too
            selectedColorInfo.style.display = 'block';
            modalColorName.textContent = availableColors[0].name;
        } else {
            selectedColorInfo.style.display = 'none';
        }
        
        // Price display in modal
        const modalPriceContainer = document.getElementById('modalProductPriceContainer');
        if (hasActiveDiscount && currentProduct.discount_price) {
            const discountPercent = Math.round((1 - currentProduct.discount_price / currentProduct.price) * 100);
            modalPriceContainer.innerHTML = `
                <div class="price-container">
                    <span class="original-price">DA ${currentProduct.price.toLocaleString()}</span>
                    <span class="discount-price">DA ${currentProduct.discount_price.toLocaleString()}</span>
                    <span class="discount-badge">-${discountPercent}%</span>
                </div>
            `;
        } else {
            modalPriceContainer.innerHTML = `
                <div class="product-price-large">DA ${currentProduct.price.toLocaleString()}</div>
            `;
        }
        
        document.getElementById('modalSubtotal').textContent = `DA ${(currentProductPrice * currentQuantity).toLocaleString()}`;
        document.getElementById('modalDiscount').textContent = '-DA 0';
        document.getElementById('modalTotal').textContent = `DA ${(currentProductPrice * currentQuantity).toLocaleString()}`;
        
        document.getElementById('modalDiscount').style.color = '';
    }

    function closeOrderNowModal() {
        const modal = document.getElementById('orderNowModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }

    // Promo code validation with backend
    async function validatePromoCode(code) {
        try {
            // Send orderAmount so the server can calculate discount correctly
            const subtotal = currentProductPrice * currentQuantity;
            
            const response = await fetch(`${API_BASE}/cart/validate-promo`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    promoCode: code,
                    orderAmount: subtotal
                })
            });
            
            if (response.ok) {
                return await response.json();
            } else {
                return { valid: false, message: 'Invalid promo code' };
            }
        } catch (error) {
            console.error('Error validating promo code:', error);
            return { valid: false, message: 'Error validating promo code' };
        }
    }

    async function applyPromoCode() {
        const promoInput = document.getElementById('orderPromoCode');
        const code = promoInput.value.trim();
        const promoMessage = document.getElementById('promoMessage');
        
        if (!code) {
            promoMessage.textContent = 'Please enter a promo code';
            promoMessage.className = 'promo-message promo-error';
            promoMessage.style.display = 'block';
            return;
        }
        
        if (appliedPromoCode) {
            promoMessage.textContent = 'A promo code has already been applied';
            promoMessage.className = 'promo-message promo-error';
            promoMessage.style.display = 'block';
            return;
        }
        
        const result = await validatePromoCode(code);
        
        if (result.valid) {
            appliedPromoCode = code.toUpperCase();
            promoMessage.textContent = result.message;
            promoMessage.className = 'promo-message promo-success';
            promoMessage.style.display = 'block';
            
            promoInput.value = appliedPromoCode;
            promoInput.disabled = true;
            document.getElementById('applyPromoBtn').textContent = 'Remove';
            
            updateOrderSummary(result.discount_amount);
        } else {
            promoMessage.textContent = result.message;
            promoMessage.className = 'promo-message promo-error';
            promoMessage.style.display = 'block';
            
            promoInput.classList.add('promo-error');
            setTimeout(() => promoInput.classList.remove('promo-error'), 300);
        }
    }

    function removePromoCode() {
        appliedPromoCode = null;
        const promoInput = document.getElementById('orderPromoCode');
        const promoMessage = document.getElementById('promoMessage');
        
        promoInput.value = '';
        promoInput.disabled = false;
        document.getElementById('applyPromoBtn').textContent = 'Apply';
        promoMessage.style.display = 'none';
        
        updateOrderSummary(0);
    }

    function updateOrderSummary(discountAmount = 0) {
        const subtotal = currentProductPrice * currentQuantity;
        const discount = discountAmount;
        const total = subtotal - discount;
        
        document.getElementById('modalSubtotal').textContent = `DA ${subtotal.toLocaleString()}`;
        document.getElementById('modalTotal').textContent = `DA ${total.toLocaleString()}`;
        
        const discountElem = document.getElementById('modalDiscount');
        discountElem.textContent = `-DA ${discount.toLocaleString()}`;
        
        if (appliedPromoCode) {
            discountElem.style.color = '#28a745';
        } else {
            discountElem.style.color = '';
        }
    }

    // Show alert message
    function showOrderAlert(message, type = 'success') {
        const alertElement = document.getElementById('alert-message');
        if (alertElement) {
            alertElement.textContent = message;
            alertElement.className = `alert-message ${type === 'success' ? 'alert-success' : 'alert-error'}`;
            alertElement.style.display = 'block';
            
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 5000);
        }
    }

    // Submit order to backend
    async function submitOrder(orderData) {
        try {
            const response = await fetch(`${API_BASE}/orders/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            });
            
            if (response.ok) {
                return await response.json();
            } else {
                throw new Error('Failed to create order');
            }
        } catch (error) {
            console.error('Error submitting order:', error);
            throw error;
        }
    }

    // Form submission
    document.getElementById('order-now-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const firstName = document.getElementById('orderFirstName').value;
        const phoneNumber = document.getElementById('orderPhoneNumber').value;
        const address = document.getElementById('orderAddress').value;
        const wilaya = document.getElementById('orderWilaya').value;
        
        if (!firstName || !phoneNumber || !address || !wilaya) {
            showOrderAlert('Please fill in all required fields', 'error');
            return;
        }
        
        const phoneRegex = /^[0-9+\-\s()]{10,}$/;
        if (!phoneRegex.test(phoneNumber)) {
            showOrderAlert('Please enter a valid phone number', 'error');
            return;
        }
        
        const productTitle = document.getElementById('productTitle').textContent;
        const productId = new URLSearchParams(window.location.search).get('product');
        
        // Use applied promo code to calculate server side
        const subtotal = currentProductPrice * currentQuantity;
        
        const orderData = {
            phoneNumber: phoneNumber,
            customerName: firstName,
            wilaya: wilaya,
            address: address,
            promoCode: appliedPromoCode, // Send promo code to server
            items: [{
                productId: productId,
                name: productTitle,
                quantity: currentQuantity,
                price: currentProductPrice,
                color: '',
                image: document.getElementById('mainProductImage').src,
                // Send selected color to server - for single color products, use the automatically selected color
                selected_color: selectedColor || (availableColors.length === 1 ? availableColors[0].name : '')
            }]
        };
            
        const submitBtn = document.querySelector('#order-now-form .confirm-btn');
        submitBtn.classList.add('success-animation');
        
        try {
            const result = await submitOrder(orderData);
            showOrderAlert(`Order for ${productTitle} confirmed successfully! Order ID: ${result.orderId}. You will receive a confirmation call shortly.`);
            
            document.getElementById('order-now-form').reset();
            
            setTimeout(() => {
                submitBtn.classList.remove('success-animation');
            }, 1000);
            
            setTimeout(() => {
                closeOrderNowModal();
            }, 3000);
            
        } catch (error) {
            showOrderAlert('Failed to create order. Please try again.', 'error');
            submitBtn.classList.remove('success-animation');
        }
    });

    // Initialize the page
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('Product page loaded');
        
        // Add window resize handler
        window.addEventListener('resize', handleResize);
        
        // Get product from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('product');
        
        if (!productId) {
            console.error('No product ID specified in URL');
            showCartMessage('Product not found. Please select a valid product.', 'error');
            return;
        }
        
        // Show loading states
        document.getElementById('productTitle').classList.add('loading');
        document.getElementById('productPrice').classList.add('loading');
        document.getElementById('productDescription').classList.add('loading');
        
        currentProduct = await fetchProduct(productId);
        
        if (currentProduct) {
            updateProductDisplay(currentProduct);
            updateImages(currentProduct);
            
            // Set up navigation arrows
            document.querySelector('.nav-prev')?.addEventListener('click', () => navigateImage('prev'));
            document.querySelector('.nav-next')?.addEventListener('click', () => navigateImage('next'));
            
            // Set up order button
            document.getElementById('orderNowBtn')?.addEventListener('click', openOrderNowModal);
            
            // Set up add to cart button
            document.getElementById('addToCartBtn')?.addEventListener('click', function() {
                addToCart(currentProduct, currentQuantity, selectedColor);
            });

            // Quantity controls
            document.getElementById('decreaseQuantity')?.addEventListener('click', function() {
                if (currentQuantity > 1) {
                    currentQuantity--;
                    document.getElementById('quantityInput').value = currentQuantity;
                    updateQuantityControls();
                }
            });

            document.getElementById('increaseQuantity')?.addEventListener('click', function() {
                if (currentQuantity < currentProductQuantity) {
                    currentQuantity++;
                    document.getElementById('quantityInput').value = currentQuantity;
                    updateQuantityControls();
                }
            });

            document.getElementById('quantityInput')?.addEventListener('change', function() {
                let newQuantity = parseInt(this.value);
                if (isNaN(newQuantity) || newQuantity < 1) {
                    newQuantity = 1;
                } else if (newQuantity > currentProductQuantity) {
                    newQuantity = currentProductQuantity;
                }
                currentQuantity = newQuantity;
                this.value = currentQuantity;
                updateQuantityControls();
            });
        } else {
            console.error('Product not found');
            showCartMessage('Product not found. Please try again.', 'error');
        }
        
        // Set up cart message close
        document.getElementById('cartMessageClose')?.addEventListener('click', hideCartMessage);
        
        // Set up modal close events
        document.getElementById('orderNowModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeOrderNowModal();
        });
        
        document.querySelector('#orderNowModal .close-modal')?.addEventListener('click', closeOrderNowModal);
        
        // Set up promo code button
        document.getElementById('applyPromoBtn')?.addEventListener('click', function() {
            if (this.textContent === 'Apply') {
                applyPromoCode();
            } else {
                removePromoCode();
            }
        });
        
        updateCartCount();
        
        // Bottom Navigation Menu Button functionality
        $('.menu-trigger-bottom').click(function(e) {
            e.preventDefault();
            $('.header-area .menu-trigger').trigger('click');
        });
    });
    </script>
</body>
</html>